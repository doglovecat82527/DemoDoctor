// 使用内置的fetch API，无需导入

// 直接嵌入预设数据，避免Netlify文件系统访问问题
const presetData = [
  {
    "id": "case_001",
    "input": "失眠多梦，口干舌燥，脾气大",
    "keywords": [
      "失眠",
      "多梦",
      "口干",
      "舌燥",
      "脾气",
      "烦躁",
      "易怒"
    ],
    "report": {
      "zh": "## 关于患者的中医诊断与调理方案\n\n### 一、四诊信息汇总\n- **主诉**：失眠多梦，口干舌燥，脾气烦躁，持续2周\n- **望诊**：舌红，苔薄黄\n- **问诊**：\n  - 寒热：无明显寒热\n  - 汗出：夜间盗汗\n  - 睡眠：入睡困难，多梦易醒\n  - 情绪：烦躁易怒\n\n### 二、特征分析与辨证\n- **核心病机分析**：患者因长期压力，导致肝的功能失调，表现为气机郁结，进而影响心神，形成肝郁化火之证。\n- **证型诊断**：肝郁化火证\n\n### 三、诊断结论\n- **病名（中医）**：不寐\n- **证型（中医）**：肝郁化火证\n\n### 四、治疗方案\n- **治则**：疏肝解郁，清热安神\n- **药方**：\n  - **方名**：甘麦大枣汤加减\n  - **组成与剂量**：\n    - 甘草 6g（调和诸药）\n    - 小麦 30g（养心安神）\n    - 大枣 10枚（补脾益气）\n    - 柴胡 9g（疏肝解郁）\n    - 黄连 3g（清热泻火）\n    - 酸枣仁 15g（养心安神）\n  - **煎服方法**：每日一剂，水煎分两次温服。忌生冷油腻。\n\n### 五、生活调养建议\n- **饮食建议**：\n  - 宜食：莲子、百合、银耳等清热安神之品\n  - 忌食：辛辣刺激、咖啡、浓茶等\n- **情志调理**：保持心情舒畅，可尝试冥想、深呼吸\n- **起居运动**：规律作息，晚上10点前入睡\n- **穴位保健**：按揉神门穴、三阴交穴各5分钟\n\n---\n> **免责声明**：本诊断报告由AI生成，仅供参考，不能替代专业医师诊疗。",
      "en": "## TCM Diagnosis and Treatment Plan\n\n### I. Four Diagnostic Methods Summary\n- **Chief Complaint**: Insomnia, vivid dreams, dry mouth, irritability for 2 weeks\n- **Inspection**: Red tongue with thin yellow coating\n- **Inquiry**: Night sweats, difficulty falling asleep, vivid dreams, irritability\n\n### II. Pattern Analysis\n- **Core Pathogenesis**: Liver qi stagnation transforming into fire\n- **Pattern Diagnosis**: Liver qi stagnation with heat\n\n### III. Diagnosis\n- **Disease**: Insomnia\n- **Pattern**: Liver qi stagnation with heat\n\n### IV. Treatment Plan\n- **Treatment Principle**: Soothe liver, clear heat, calm spirit\n- **Herbal Formula**: Modified Gan Mai Da Zao Tang\n  - Licorice 6g, Wheat 30g, Jujube 10 pieces\n  - Bupleurum 9g, Coptis 3g, Jujube seed 15g\n\n### V. Lifestyle Recommendations\n- **Diet**: Lotus seeds, lily bulbs, white fungus\n- **Avoid**: Spicy foods, coffee, strong tea\n- **Sleep**: Regular schedule, sleep before 10 PM\n\n---\n> **Disclaimer**: This AI-generated report is for reference only."
    }
  },
  {
    "id": "case_002",
    "input": "胃痛胃胀，食欲不振",
    "keywords": [
      "胃痛",
      "胃胀",
      "食欲不振",
      "消化不良",
      "腹胀"
    ],
    "report": {
      "zh": "## 关于患者的中医诊断与调理方案\n\n### 一、四诊信息汇总\n- **主诉**：胃脘疼痛，腹胀，食欲不振，持续1周\n- **望诊**：舌淡红，苔白腻\n- **问诊**：\n  - 疼痛性质：隐痛，饭后加重\n  - 消化：食后腹胀，嗳气\n  - 大便：偏稀，不成形\n\n### 二、特征分析与辨证\n- **核心病机分析**：脾胃虚弱，运化失司，湿浊内生\n- **证型诊断**：脾胃虚弱证\n\n### 三、诊断结论\n- **病名（中医）**：胃脘痛\n- **证型（中医）**：脾胃虚弱证\n\n### 四、治疗方案\n- **治则**：健脾益胃，理气消胀\n- **药方**：\n  - **方名**：香砂六君子汤\n  - **组成与剂量**：\n    - 党参 15g（补气健脾）\n    - 白术 12g（健脾燥湿）\n    - 茯苓 15g（健脾利湿）\n    - 甘草 6g（调和诸药）\n    - 陈皮 9g（理气化痰）\n    - 半夏 9g（降逆止呕）\n    - 木香 6g（行气止痛）\n    - 砂仁 6g（化湿开胃）\n\n### 五、生活调养建议\n- **饮食建议**：\n  - 宜食：小米粥、山药、红枣等健脾食物\n  - 忌食：生冷、油腻、难消化食物\n- **起居调理**：规律饮食，细嚼慢咽\n- **穴位保健**：按揉足三里、中脘穴\n\n---\n> **免责声明**：本诊断报告由AI生成，仅供参考，不能替代专业医师诊疗。",
      "en": "## TCM Diagnosis and Treatment Plan\n\n### I. Four Diagnostic Methods Summary\n- **Chief Complaint**: Stomach pain, bloating, poor appetite for 1 week\n- **Inspection**: Pale red tongue with white greasy coating\n- **Inquiry**: Dull pain worse after eating, bloating, loose stools\n\n### II. Pattern Analysis\n- **Core Pathogenesis**: Spleen and stomach deficiency\n- **Pattern Diagnosis**: Spleen and stomach qi deficiency\n\n### III. Diagnosis\n- **Disease**: Stomach pain\n- **Pattern**: Spleen and stomach qi deficiency\n\n### IV. Treatment Plan\n- **Treatment Principle**: Strengthen spleen, harmonize stomach\n- **Herbal Formula**: Xiang Sha Liu Jun Zi Tang\n\n### V. Lifestyle Recommendations\n- **Diet**: Millet porridge, Chinese yam, red dates\n- **Avoid**: Cold, greasy, hard-to-digest foods\n- **Acupoints**: Zusanli, Zhongwan\n\n---\n> **Disclaimer**: This AI-generated report is for reference only."
    }
  },
  {
    "id": "case_003",
    "input": "咳嗽有痰，喉咙痛",
    "keywords": [
      "咳嗽",
      "有痰",
      "喉咙痛",
      "咽痛",
      "痰多"
    ],
    "report": {
      "zh": "## 关于患者的中医诊断与调理方案\n\n### 一、四诊信息汇总\n- **主诉**：咳嗽，咽痛，痰多色白，持续3天\n- **望诊**：舌淡红，苔薄白\n- **问诊**：\n  - 咳嗽：阵发性，痰易咳出\n  - 咽喉：疼痛，干燥感\n  - 全身：轻微恶寒，无发热\n\n### 二、特征分析与辨证\n- **核心病机分析**：风寒袭肺，肺气失宣，津液凝聚成痰\n- **证型诊断**：风寒咳嗽证\n\n### 三、诊断结论\n- **病名（中医）**：咳嗽\n- **证型（中医）**：风寒咳嗽证\n\n### 四、治疗方案\n- **治则**：疏风散寒，宣肺止咳\n- **药方**：\n  - **方名**：三拗汤加减\n  - **组成与剂量**：\n    - 麻黄 6g（宣肺平喘）\n    - 杏仁 9g（止咳化痰）\n    - 甘草 6g（润肺止咳）\n    - 桔梗 9g（宣肺利咽）\n    - 紫苏叶 9g（疏风散寒）\n    - 陈皮 6g（理气化痰）\n\n### 五、生活调养建议\n- **饮食建议**：\n  - 宜食：梨、蜂蜜、银耳等润肺食物\n  - 忌食：辛辣、煎炸、生冷食物\n- **起居调理**：注意保暖，避风寒\n- **穴位保健**：按揉肺俞、列缺穴\n\n---\n> **免责声明**：本诊断报告由AI生成，仅供参考，不能替代专业医师诊疗。",
      "en": "## TCM Diagnosis and Treatment Plan\n\n### I. Four Diagnostic Methods Summary\n- **Chief Complaint**: Cough with white phlegm, sore throat for 3 days\n- **Inspection**: Pale red tongue with thin white coating\n- **Inquiry**: Paroxysmal cough, easy expectoration, mild aversion to cold\n\n### II. Pattern Analysis\n- **Core Pathogenesis**: Wind-cold attacking lungs\n- **Pattern Diagnosis**: Wind-cold cough pattern\n\n### III. Diagnosis\n- **Disease**: Cough\n- **Pattern**: Wind-cold cough\n\n### IV. Treatment Plan\n- **Treatment Principle**: Dispel wind-cold, open lungs, stop cough\n- **Herbal Formula**: Modified San Ao Tang\n\n### V. Lifestyle Recommendations\n- **Diet**: Pears, honey, white fungus\n- **Avoid**: Spicy, fried, cold foods\n- **Acupoints**: Feishu, Lieque\n\n---\n> **Disclaimer**: This AI-generated report is for reference only."
    }
  },
  {
    "id": "case_004",
    "input": "头痛眩晕，月经不调",
    "keywords": [
      "头痛",
      "眩晕",
      "月经不调",
      "面色萎黄",
      "神疲乏力",
      "心悸",
      "失眠"
    ],
    "report": {
      "zh": "## 关于患者的中医诊断与调理方案\n\n### 一、四诊信息汇总\n- **主诉**：近3个月经常头痛、眩晕，月经不调（量少色淡），伴神疲乏力、心悸失眠。\n- **望诊**：面色萎黄，舌淡苔薄白。\n- **问诊**：工作压力大、经常熬夜，月经量少色淡，脉细弱。\n\n### 二、特征分析与辨证\n- **核心病机分析**：长期熬夜及压力耗伤气血，导致**气血两虚**。血虚不能上荣头目，故头痛、眩晕、面色萎黄；血海空虚则月经量少色淡；气虚则神疲乏力；血不养心故心悸失眠。舌淡、脉细弱为气血不足之象。\n- **证型诊断**：气血两虚证（兼轻度心脾两虚）。\n\n### 三、诊断结论\n- **病名（中医）**：头痛、月经不调、眩晕（均属气血亏虚范畴）\n- **证型（中医）**：气血两虚证\n\n### 四、治疗方案\n- **治则**：益气养血，健脾宁心\n- **药方**：\n  - **方名**：归脾汤合四物汤加减\n  - **组成与剂量**：\n    - 黄芪20g、党参15g（补气）\n    - 当归12g、熟地15g、白芍10g（养血）\n    - 炒白术10g、茯苓15g（健脾）\n    - 酸枣仁15g、远志6g（安神）\n    - 川芎6g（活血止痛，引药上行）\n    - 炙甘草6g（调和诸药）\n  - **煎服方法**：每日1剂，水煎取汁300ml，早晚分服（饭后温服），连续2周后复诊调整。\n\n### 五、生活调养建议\n- **饮食建议**：\n  - 宜食：红枣、桂圆、山药、瘦肉、猪肝、黑芝麻、菠菜等补气血之品。\n  - 忌食：生冷寒凉（如冷饮、西瓜）及辛辣耗气之物。\n- **情志调理**：\n  - 避免过度思虑，可通过冥想、音乐舒缓压力，保证每日有放松时间。\n- **起居运动**：\n  - 严格避免熬夜（建议22点前入睡），每日睡眠不少于7小时。\n  - 练习八段锦、太极拳等柔缓运动，忌剧烈耗气活动。\n- **穴位保健**：\n  - 足三里（健脾益气）、三阴交（调经养血）、百会（升清阳止眩晕），每日每穴按压5-10分钟。\n\n---\n> **免责声明**：本诊断报告由AI生成，仅供参考，不能替代专业医师诊疗。",
      "en": "## TCM Diagnosis and Treatment Plan\n\n### I. Four Diagnostic Methods Summary\n- **Chief Complaint**: Headache, dizziness, irregular menstruation for 3 months\n- **Inspection**: Pale complexion, pale tongue with thin white coating\n- **Inquiry**: Work stress, frequent late nights, scanty pale menstruation\n\n### II. Pattern Analysis\n- **Core Pathogenesis**: Qi and blood deficiency due to overwork\n- **Pattern Diagnosis**: Qi and blood deficiency\n\n### III. Diagnosis\n- **Disease**: Headache, irregular menstruation, dizziness\n- **Pattern**: Qi and blood deficiency\n\n### IV. Treatment Plan\n- **Treatment Principle**: Tonify qi and nourish blood\n- **Herbal Formula**: Modified Gui Pi Tang and Si Wu Tang\n\n### V. Lifestyle Recommendations\n- **Diet**: Red dates, longan, Chinese yam, lean meat\n- **Avoid**: Cold foods, spicy foods\n- **Sleep**: Regular schedule, avoid staying up late\n\n---\n> **Disclaimer**: This AI-generated report is for reference only."
    }
  },
  {
    "id": "case_005",
    "input": "你能做什么",
    "keywords": [
      "你能做什么",
      "功能",
      "能力",
      "介绍",
      "帮助"
    ],
    "report": {
      "zh": "## 中医AI诊断助手功能介绍\n\n### 我能为您提供的服务\n\n#### 🔍 中医症状分析\n- 根据您描述的症状进行中医辨证分析\n- 提供四诊合参的综合评估\n- 分析病机和证型\n\n#### 📋 个性化诊断报告\n- 详细的中医诊断结论\n- 治疗原则和方案建议\n- 中药方剂推荐（仅供参考）\n\n#### 🌿 生活调养指导\n- 饮食宜忌建议\n- 起居作息调理\n- 情志调节方法\n- 穴位保健指导\n\n#### 💡 使用方法\n1. **描述症状**：详细描述您的身体不适症状\n2. **获取分析**：系统将进行中医辨证分析\n3. **查看报告**：获得详细的诊断和调理建议\n\n#### ⚠️ 重要提醒\n- 本系统提供的建议仅供参考\n- 不能替代专业医师的诊断和治疗\n- 如有严重症状，请及时就医\n- 服用中药前请咨询专业中医师\n\n#### 🎯 适用场景\n- 日常健康咨询\n- 中医养生指导\n- 症状初步分析\n- 健康知识学习\n\n---\n> **免责声明**：本AI助手仅提供中医理论参考，不构成医疗建议。",
      "en": "## TCM AI Diagnostic Assistant Features\n\n### Services I Can Provide\n\n#### 🔍 TCM Symptom Analysis\n- Analyze symptoms using TCM pattern differentiation\n- Comprehensive assessment using four diagnostic methods\n- Pathogenesis and pattern analysis\n\n#### 📋 Personalized Diagnostic Reports\n- Detailed TCM diagnosis conclusions\n- Treatment principles and recommendations\n- Herbal formula suggestions (for reference only)\n\n#### 🌿 Lifestyle Guidance\n- Dietary recommendations\n- Daily routine adjustments\n- Emotional regulation methods\n- Acupoint health guidance\n\n#### 💡 How to Use\n1. **Describe Symptoms**: Detail your physical discomfort\n2. **Get Analysis**: System performs TCM pattern differentiation\n3. **View Report**: Receive detailed diagnosis and care advice\n\n#### ⚠️ Important Reminders\n- Suggestions are for reference only\n- Cannot replace professional medical diagnosis\n- Seek immediate medical attention for serious symptoms\n- Consult TCM practitioners before taking herbs\n\n---\n> **Disclaimer**: This AI assistant provides TCM theoretical reference only."
    }
  }
];

const presetDataStatus = 'embedded';
console.log('预设数据已直接嵌入，条目数量:', presetData.length);

// 关键词匹配函数
function matchPresetData(input) {
  const inputLower = input.toLowerCase();
  
  for (const preset of presetData) {
    // 检查是否包含关键词
    const matchCount = preset.keywords.filter(keyword => 
      inputLower.includes(keyword.toLowerCase())
    ).length;
    
    // 如果匹配到2个或以上关键词，认为匹配成功
    if (matchCount >= 2) {
      return preset;
    }
  }
  
  return null;
}

exports.handler = async (event, context) => {
  const startTime = Date.now();
  console.log('=== Netlify Function 开始执行 ===');
  console.log('执行时间:', new Date().toISOString());
  console.log('HTTP Method:', event.httpMethod);
  console.log('User-Agent:', event.headers['user-agent']);
  console.log('Origin:', event.headers.origin);
  console.log('Body length:', event.body?.length || 0);
  console.log('预设数据状态:', presetDataStatus);
  console.log('预设数据条目数:', presetData.length);
  
  // 只允许POST请求
  if (event.httpMethod !== 'POST') {
    console.log('错误: 不支持的HTTP方法');
    return {
      statusCode: 405,
      body: JSON.stringify({ error: 'Method not allowed' })
    };
  }

  try {
    const { input, language = 'zh' } = JSON.parse(event.body);
    console.log('解析的输入参数:', { input: input?.substring(0, 100) + '...', language });
    
    if (!input) {
      console.log('错误: 缺少输入参数');
      return {
        statusCode: 400,
        body: JSON.stringify({ error: '缺少必要参数' })
      };
    }

    // 首先尝试匹配预设数据
    const matchedPreset = matchPresetData(input);
    if (matchedPreset) {
      console.log('Found matching preset data for input:', input);
      return {
        statusCode: 200,
        headers: {
          'Content-Type': 'application/json',
          'Access-Control-Allow-Origin': '*',
          'Access-Control-Allow-Headers': 'Content-Type',
          'Access-Control-Allow-Methods': 'POST, OPTIONS'
        },
        body: JSON.stringify({
          success: true,
          data: {
            report: matchedPreset.report[language] || matchedPreset.report.zh,
            source: 'preset'
          }
        })
      };
    }

    console.log('No preset match found, calling Deepseek API for input:', input);

    // 调用Deepseek API
    const apiKey = process.env.DEEPSEEK_API_KEY;
    console.log('API密钥检查:', apiKey ? `存在 (长度: ${apiKey.length}, 前缀: ${apiKey.substring(0, 8)}...)` : '不存在');
    console.log('所有环境变量数量:', Object.keys(process.env).length);
    console.log('DEEPSEEK相关环境变量:', Object.keys(process.env).filter(key => key.includes('DEEPSEEK')));
    console.log('NODE_ENV:', process.env.NODE_ENV);
    console.log('NETLIFY:', process.env.NETLIFY);
    
    if (!apiKey) {
      console.log('错误: API密钥未配置');
      return {
        statusCode: 500,
        body: JSON.stringify({ 
          success: false,
          error: 'API密钥未配置',
          debug: {
            env_keys: Object.keys(process.env).filter(key => key.includes('DEEPSEEK')),
            all_env_keys: Object.keys(process.env).length
          }
        })
      };
    }

    let prompt;
    
    if (language === 'zh') {
      prompt = `你是一位经验丰富的中医师，请根据患者描述的症状进行中医诊断分析。

患者症状描述：${input}

请按照以下格式提供详细的中医诊断报告：

## 关于患者的中医诊断与调理方案

### 一、四诊合参
- **主诉**：[主要症状]
- **望诊**：[舌象等]
- **闻诊**：[声音气味等]
- **问诊**：[详细询问结果]
- **切诊**：[脉象等]

### 二、中医诊断
- **病名**：[中医病名]
- **证型**：[具体证型]
- **病机**：[发病机理]

### 三、治疗原则
[治疗大法和具体原则]

### 四、治疗方案

#### 方药治疗
**方名**：[方剂名称]
**组成**：
- 药材1 用量
- 药材2 用量
- 药材3 用量
[继续列出所有药材]

**用法**：[煎服方法]
**功效**：[方剂功效]
**方解**：[方剂分析]

#### 其他治疗
- **针灸**：[穴位和方法]
- **推拿**：[手法和部位]
- **食疗**：[饮食建议]

### 五、调护建议
- **起居**：[作息建议]
- **饮食**：[饮食宜忌]
- **情志**：[情绪调节]
- **运动**：[运动建议]

### 六、复诊安排
[复诊时间和注意事项]

请提供专业、详细的中医诊断报告。`;
    } else {
      prompt = `You are an experienced Traditional Chinese Medicine (TCM) practitioner. Please provide a TCM diagnosis based on the patient's symptoms.

Patient symptoms: ${input}

Please provide a detailed TCM diagnosis report in the following format:

## TCM Diagnosis and Treatment Plan

### I. Four Diagnostic Methods Summary
- **Chief Complaint**: [Main symptoms]
- **Inspection**: [Tongue examination, etc.]
- **Auscultation & Olfaction**: [Sound and smell observations]
- **Inquiry**: [Detailed questioning results]
- **Palpation**: [Pulse examination, etc.]

### II. TCM Diagnosis
- **Disease Name**: [TCM disease name]
- **Pattern**: [Specific pattern]
- **Pathogenesis**: [Disease mechanism]

### III. Treatment Principles
[Treatment methods and specific principles]

### IV. Treatment Plan

#### Herbal Formula
**Formula Name**: [Formula name]
**Composition**:
- Herb 1 dosage
- Herb 2 dosage
- Herb 3 dosage
[Continue listing all herbs]

**Usage**: [Preparation and administration]
**Effects**: [Formula effects]
**Analysis**: [Formula analysis]

#### Additional Treatments
- **Acupuncture**: [Points and methods]
- **Tuina Massage**: [Techniques and locations]
- **Dietary Therapy**: [Dietary recommendations]

### V. Lifestyle Recommendations
- **Daily Routine**: [Schedule recommendations]
- **Diet**: [Dietary guidelines]
- **Emotional**: [Emotional regulation]
- **Exercise**: [Exercise recommendations]

### VI. Follow-up
[Follow-up schedule and precautions]

Please provide a professional and detailed TCM diagnosis report.`;
    }

    console.log('开始调用Deepseek API...');
    const requestBody = {
      model: 'deepseek-chat',
      messages: [
        {
          role: 'user',
          content: prompt
        }
      ],
      temperature: 0.7,
      max_tokens: 2000
    };
    console.log('API请求体大小:', JSON.stringify(requestBody).length, 'bytes');
    console.log('Prompt长度:', prompt.length);
    
    // 添加超时控制
    const controller = new AbortController();
    const timeoutId = setTimeout(() => {
      console.log('API调用超时，中止请求');
      controller.abort();
    }, 25000); // 25秒超时
    
    try {
      const response = await fetch('https://api.deepseek.com/chat/completions', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${apiKey}`
        },
        body: JSON.stringify(requestBody),
        signal: controller.signal
      });
      
      clearTimeout(timeoutId);

      console.log('API响应状态:', response.status);
      console.log('API响应头Content-Type:', response.headers.get('content-type'));
      
      if (!response.ok) {
        const errorText = await response.text();
        console.error('API调用失败:', response.status, errorText);
        throw new Error(`API调用失败: ${response.status} ${errorText}`);
      }
      
      const data = await response.json();
      console.log('API响应数据结构:', {
        hasChoices: !!data.choices,
        choicesLength: data.choices?.length || 0,
        hasUsage: !!data.usage,
        model: data.model
      });
      
      if (data.choices && data.choices.length > 0) {
        const diagnosis = data.choices[0].message.content;
        console.log('诊断结果长度:', diagnosis.length);
        console.log('诊断结果前100字符:', diagnosis.substring(0, 100));
        
        const executionTime = Date.now() - startTime;
        console.log('总执行时间:', executionTime, 'ms');
        
        return {
          statusCode: 200,
          headers: {
            'Content-Type': 'application/json',
            'Access-Control-Allow-Origin': '*',
            'Access-Control-Allow-Headers': 'Content-Type',
            'Access-Control-Allow-Methods': 'POST, OPTIONS'
          },
          body: JSON.stringify({
            success: true,
            data: {
              report: diagnosis,
              source: 'deepseek_api',
              executionTime: executionTime
            }
          })
        };
      } else {
        console.error('API响应格式异常:', data);
        throw new Error('API响应格式异常');
      }
    } catch (fetchError) {
      clearTimeout(timeoutId);
      console.error('API调用异常:', fetchError.message);
      console.error('异常类型:', fetchError.name);
      console.error('异常堆栈:', fetchError.stack);
      
      if (fetchError.name === 'AbortError') {
        console.log('请求被中止（超时）');
        throw new Error('API调用超时，请稍后重试');
      }
      throw fetchError;
    }

  } catch (error) {
    const executionTime = Date.now() - startTime;
    console.error('=== 诊断服务错误 ===');
    console.error('错误时间:', new Date().toISOString());
    console.error('执行时间:', executionTime, 'ms');
    console.error('错误消息:', error.message);
    console.error('错误类型:', error.name);
    console.error('错误堆栈:', error.stack);
    console.error('预设数据状态:', presetDataStatus);
    console.error('环境变量DEEPSEEK_API_KEY存在:', !!process.env.DEEPSEEK_API_KEY);
    
    // 根据错误类型提供更具体的错误信息
    let errorMessage = '诊断服务暂时不可用，请稍后重试';
    if (error.message.includes('超时')) {
      errorMessage = '诊断服务响应超时，请稍后重试';
    } else if (error.message.includes('API密钥')) {
      errorMessage = '服务配置错误，请联系管理员';
    } else if (error.message.includes('网络')) {
      errorMessage = '网络连接异常，请检查网络后重试';
    }
    
    return {
      statusCode: 500,
      headers: {
        'Content-Type': 'application/json',
        'Access-Control-Allow-Origin': '*',
        'Access-Control-Allow-Headers': 'Content-Type',
        'Access-Control-Allow-Methods': 'POST, OPTIONS'
      },
      body: JSON.stringify({
        success: false,
        error: errorMessage,
        details: error.message,
        executionTime: executionTime,
        timestamp: new Date().toISOString()
      })
    };
  }
};