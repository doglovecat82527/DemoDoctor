# AI医疗Demo部署指南

## 1. 部署概述

本项目采用现代化的无服务器部署方案，使用Vercel平台实现前后端一体化部署。这种方案具有以下优势：

- **零配置部署**: 无需服务器运维，专注业务开发
- **自动扩缩容**: 根据访问量自动调整资源
- **全球CDN**: 确保全球用户访问速度
- **免费额度**: 对于Demo项目完全免费
- **HTTPS默认**: 自动提供SSL证书

## 2. 部署前准备

### 2.1 账号注册

1. **GitHub账号**: 用于代码托管和版本控制
2. **Vercel账号**: 用于项目部署（可使用GitHub账号登录）
3. **Deepseek账号**: 用于获取API密钥

### 2.2 API密钥获取

**Deepseek API密钥获取步骤**:

1. 访问 [Deepseek开放平台](https://platform.deepseek.com/)
2. 注册并登录账号
3. 进入API管理页面
4. 创建新的API密钥
5. 复制并安全保存密钥（格式：`sk-xxxxxxxxxxxxxxxx`）

**重要提醒**:
- API密钥具有敏感性，请妥善保管
- 不要将密钥提交到代码仓库
- 建议设置API调用限额以控制成本

### 2.3 项目结构准备

确保项目目录结构如下：
```
DemoDoctor/
├── frontend/          # React前端项目
│   ├── src/
│   ├── public/
│   ├── package.json
│   └── vite.config.ts
├── api/              # Express后端API
│   ├── diagnosis.ts
│   ├── download.ts
│   └── package.json
├── vercel.json       # Vercel部署配置
├── package.json      # 根目录配置
└── README.md
```

## 3. 自动化部署流程

### 3.1 GitHub仓库设置

1. **创建GitHub仓库**:
   ```bash
   git init
   git add .
   git commit -m "Initial commit"
   git branch -M main
   git remote add origin https://github.com/yourusername/ai-medical-demo.git
   git push -u origin main
   ```

2. **配置.gitignore**:
   ```gitignore
   # 依赖
   node_modules/
   
   # 环境变量
   .env
   .env.local
   .env.production
   
   # 构建输出
   dist/
   build/
   
   # 日志
   *.log
   
   # 操作系统
   .DS_Store
   Thumbs.db
   ```

### 3.2 Vercel部署配置

**vercel.json配置文件**:
```json
{
  "version": 2,
  "name": "ai-medical-demo",
  "builds": [
    {
      "src": "frontend/package.json",
      "use": "@vercel/static-build",
      "config": {
        "distDir": "dist"
      }
    },
    {
      "src": "api/**/*.ts",
      "use": "@vercel/node"
    }
  ],
  "routes": [
    {
      "src": "/api/(.*)",
      "dest": "/api/$1"
    },
    {
      "src": "/(.*)",
      "dest": "/frontend/$1"
    }
  ],
  "functions": {
    "api/**/*.ts": {
      "runtime": "nodejs18.x"
    }
  }
}
```

### 3.3 一键部署步骤

1. **连接Vercel与GitHub**:
   - 访问 [Vercel Dashboard](https://vercel.com/dashboard)
   - 点击"New Project"
   - 选择GitHub仓库
   - 授权Vercel访问仓库

2. **配置项目设置**:
   - Project Name: `ai-medical-demo`
   - Framework Preset: `Other`
   - Root Directory: `./`
   - Build Command: `npm run build`
   - Output Directory: `frontend/dist`

3. **配置环境变量**:
   在Vercel项目设置中添加以下环境变量：
   
   | 变量名 | 值 | 环境 |
   |--------|----|----- |
   | `DEEPSEEK_API_KEY` | `sk-your-api-key-here` | Production, Preview |
   | `DEEPSEEK_BASE_URL` | `https://api.deepseek.com` | Production, Preview |
   | `NODE_ENV` | `production` | Production |

4. **部署项目**:
   - 点击"Deploy"按钮
   - 等待构建完成（通常2-5分钟）
   - 获得部署URL（如：`https://ai-medical-demo.vercel.app`）

## 4. 环境变量安全配置

### 4.1 生产环境配置

**在Vercel Dashboard中配置**:

1. 进入项目设置页面
2. 选择"Environment Variables"选项卡
3. 添加以下变量：

```bash
# Deepseek API配置
DEEPSEEK_API_KEY=sk-xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
DEEPSEEK_BASE_URL=https://api.deepseek.com
DEEPSEEK_MODEL=deepseek-chat
DEEPSEEK_MAX_TOKENS=2000

# 应用配置
NODE_ENV=production
APP_URL=https://your-domain.vercel.app

# 可选：监控和分析
VERCEL_ANALYTICS_ID=your-analytics-id
```

### 4.2 本地开发配置

**创建.env.local文件**:
```bash
# 复制.env.example到.env.local
cp .env.example .env.local

# 编辑.env.local文件
DEEPSEEK_API_KEY=sk-your-development-api-key
DEEPSEEK_BASE_URL=https://api.deepseek.com
NODE_ENV=development
```

**安全提醒**:
- 永远不要将`.env.local`文件提交到Git
- 开发和生产环境使用不同的API密钥
- 定期轮换API密钥
- 监控API使用量和成本

## 5. 自动化CI/CD流程

### 5.1 GitHub Actions配置

**创建.github/workflows/deploy.yml**:
```yaml
name: Deploy to Vercel

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
      
    - name: Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18'
        cache: 'npm'
        
    - name: Install dependencies
      run: |
        npm ci
        cd frontend && npm ci
        cd ../api && npm ci
        
    - name: Run tests
      run: npm test
      
    - name: Build project
      run: npm run build
      
    - name: Deploy to Vercel
      uses: amondnet/vercel-action@v25
      with:
        vercel-token: ${{ secrets.VERCEL_TOKEN }}
        vercel-org-id: ${{ secrets.ORG_ID }}
        vercel-project-id: ${{ secrets.PROJECT_ID }}
        vercel-args: '--prod'
```

### 5.2 部署触发机制

- **自动部署**: 推送到main分支自动触发生产部署
- **预览部署**: Pull Request自动创建预览环境
- **手动部署**: 通过Vercel Dashboard手动触发

## 6. 域名和SSL配置

### 6.1 自定义域名配置

1. **在Vercel中添加域名**:
   - 进入项目设置
   - 选择"Domains"选项卡
   - 添加自定义域名

2. **DNS配置**:
   ```
   类型: CNAME
   名称: www
   值: cname.vercel-dns.com
   
   类型: A
   名称: @
   值: 76.76.19.61
   ```

3. **SSL证书**:
   - Vercel自动提供Let's Encrypt SSL证书
   - 支持自动续期
   - 强制HTTPS重定向

### 6.2 CDN和性能优化

- **全球CDN**: Vercel提供全球边缘节点
- **自动压缩**: Gzip和Brotli压缩
- **图片优化**: 自动WebP转换
- **缓存策略**: 智能缓存控制

## 7. 监控和维护

### 7.1 性能监控

**Vercel Analytics集成**:
```javascript
// 在React应用中添加
import { Analytics } from '@vercel/analytics/react';

function App() {
  return (
    <>
      <YourApp />
      <Analytics />
    </>
  );
}
```

### 7.2 错误监控

**集成Sentry错误监控**:
```bash
npm install @sentry/react @sentry/tracing
```

```javascript
import * as Sentry from "@sentry/react";

Sentry.init({
  dsn: "YOUR_SENTRY_DSN",
  environment: process.env.NODE_ENV,
});
```

### 7.3 日志管理

**Vercel函数日志**:
- 实时日志查看
- 错误追踪
- 性能分析
- API调用统计

## 8. 故障排除

### 8.1 常见部署问题

| 问题 | 原因 | 解决方案 |
|------|------|----------|
| 构建失败 | 依赖问题 | 检查package.json和node版本 |
| API调用失败 | 环境变量未配置 | 确认Vercel环境变量设置 |
| 404错误 | 路由配置问题 | 检查vercel.json路由配置 |
| 样式丢失 | 静态资源路径问题 | 检查Vite配置和base路径 |

### 8.2 调试工具

1. **Vercel CLI调试**:
   ```bash
   npm i -g vercel
   vercel dev  # 本地模拟Vercel环境
   vercel logs # 查看部署日志
   ```

2. **浏览器开发者工具**:
   - Network面板检查API调用
   - Console面板查看错误信息
   - Application面板检查缓存

### 8.3 回滚策略

- **版本回滚**: Vercel支持一键回滚到之前版本
- **分支部署**: 使用不同分支进行测试
- **金丝雀发布**: 逐步发布新版本

## 9. 成本控制

### 9.1 Vercel免费额度

- **带宽**: 100GB/月
- **函数调用**: 100GB-小时/月
- **构建时间**: 6000分钟/月
- **域名**: 无限制

### 9.2 Deepseek API成本

- **按Token计费**: 根据输入输出Token数量
- **设置限额**: 避免意外高额费用
- **监控使用**: 定期检查API调用统计

### 9.3 优化建议

- 实现请求缓存减少API调用
- 优化预设数据匹配提高命中率
- 设置合理的API超时时间
- 监控和分析用户使用模式

## 10. 安全最佳实践

### 10.1 API安全

- API密钥仅在服务端使用
- 实现请求频率限制
- 输入数据验证和清理
- 错误信息不暴露敏感信息

### 10.2 前端安全

- 内容安全策略(CSP)
- XSS防护
- CSRF防护
- 安全的第三方依赖

### 10.3 数据保护

- 不存储用户敏感信息
- HTTPS强制加密
- 定期安全审计
- 遵循数据保护法规

---

**部署完成后，您将获得**:
- 一个可全球访问的Demo网站
- 自动HTTPS和CDN加速
- 零运维的无服务器架构
- 完整的监控和日志系统

**下一步**: 完成部署后，建议进行全面的功能测试，确保所有功能在生产环境中正常工作。